@model SSISAnalyticsDashboard.Models.DashboardViewModel
@{
    ViewData["Title"] = "SSIS Analytics Dashboard";
}

<style>
    .spinner-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }
    
    .retro-card.loading {
        opacity: 0.7;
    }
    
    #refreshBtn.loading .bi-arrow-clockwise {
        animation: retro-spin 1s linear infinite;
    }
    
    .pulse {
        animation: pulse-animation 1s ease-in-out;
    }
    
    @@keyframes pulse-animation {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
</style>

<div class="container-fluid">
    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="retro-alert retro-alert--danger" role="alert">
            <div class="retro-alert__content">
                <strong>Error!</strong> @ViewBag.ErrorMessage
            </div>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="retro-alert retro-alert--success" role="alert">
            <div class="retro-alert__content">
                <i class="bi bi-check-circle-fill"></i>
                <strong>Success!</strong> @TempData["SuccessMessage"]
            </div>
        </div>
    }

    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h1 class="retro-neon-text" style="font-family: var(--font-retro-title); font-size: var(--retro-text-4xl); margin-bottom: var(--retro-space-2);">
                <i class="bi bi-graph-up-arrow"></i> SSIS ANALYTICS
            </h1>
            <p style="font-family: var(--font-retro-mono); color: rgba(0, 245, 255, 0.7); margin-bottom: 0;">
                <i class="bi bi-server"></i> Monitor your SQL Server Integration Services executions 
                <span id="autoRefreshStatus" class="retro-badge retro-badge--green ms-2">
                    <i class="bi bi-broadcast"></i> Auto-refresh: ON
                </span>
                @if (!string.IsNullOrEmpty(ViewBag.SelectedBusinessUnit))
                {
                    <span class="retro-badge retro-badge--purple ms-2">
                        <i class="bi bi-building"></i> @ViewBag.SelectedBusinessUnit
                    </span>
                }
            </p>
        </div>
        <div class="col-md-6 text-end">
            <div class="d-flex justify-content-end gap-2 flex-wrap">
                <button class="retro-btn retro-btn--cyan" onclick="manualRefresh()" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="retro-btn retro-btn--green" onclick="exportToCSV()" id="exportBtn">
                    <i class="bi bi-download"></i> Export Data
                </button>
                <a href="@Url.Action("Index", "ServerConfig")" class="retro-btn retro-btn--purple">
                    <i class="bi bi-gear"></i> Settings
                </a>
            </div>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="retro-card retro-card--cut">
                <div class="retro-card__header">
                    <i class="bi bi-funnel-fill"></i> FILTERS
                    <button class="retro-btn retro-btn--sm float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" style="background: transparent; border: none; color: var(--neon-cyan);">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse show" id="filterCollapse">
                    <div class="retro-card__body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label style="font-family: var(--font-retro-display); color: var(--neon-cyan); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: 8px; display: block;">Business Unit</label>
                                <select class="retro-input" id="businessUnitFilter" style="padding: 8px;">
                                    <option value="">All Units</option>
                                    <option value="CLIENTREPO" @(ViewBag.SelectedBusinessUnit == "CLIENTREPO" ? "selected" : "")>ClientRepo (CR)</option>
                                    <option value="CHARTNAV" @(ViewBag.SelectedBusinessUnit == "CHARTNAV" ? "selected" : "")>ChartNav (CN)</option>
                                    <option value="EDS" @(ViewBag.SelectedBusinessUnit == "EDS" ? "selected" : "")>EDS (EDS)</option>
                                    <option value="HIM" @(ViewBag.SelectedBusinessUnit == "HIM" ? "selected" : "")>HIM (HIM)</option>
                                    <option value="UNCATEGORIZED" @(ViewBag.SelectedBusinessUnit == "UNCATEGORIZED" ? "selected" : "")>Uncategorized</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label style="font-family: var(--font-retro-display); color: var(--neon-cyan); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: 8px; display: block;">Date Range</label>
                                <select class="retro-input" id="dateRangeFilter" style="padding: 8px;">
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="1">Today</option>
                                    <option value="90">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label style="font-family: var(--font-retro-display); color: var(--neon-cyan); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: 8px; display: block;">Status Filter</label>
                                <select class="retro-input" id="statusFilter" style="padding: 8px;">
                                    <option value="">All Statuses</option>
                                    <option value="Succeeded">Succeeded</option>
                                    <option value="Failed">Failed</option>
                                    <option value="Running">Running</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label style="font-family: var(--font-retro-display); color: var(--neon-cyan); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: 8px; display: block;">Search Packages</label>
                                <input type="text" class="retro-input" id="packageSearch" placeholder="Search by package name...">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <div class="d-flex gap-2 w-100">
                                    <button class="retro-btn retro-btn--sm flex-fill" onclick="applyFilters()">
                                        <i class="bi bi-check2-circle"></i> Apply
                                    </button>
                                    <button class="retro-btn retro-btn--sm retro-btn--pink flex-fill" onclick="clearFilters()">
                                        <i class="bi bi-x-circle"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Currently Running Packages -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="retro-card retro-card--cyan retro-card--cut">
                <div class="retro-card__header" style="color: var(--neon-cyan);">
                    <i class="bi bi-play-circle-fill"></i> CURRENTLY RUNNING PACKAGES
                    <span class="retro-badge retro-badge--cyan ms-2" id="currentExecutionCount">@Model.CurrentExecutions.Count</span>
                </div>
                <div class="retro-card__body">
                    @if (Model.CurrentExecutions != null && Model.CurrentExecutions.Any())
                    {
                        <div class="table-responsive">
                            <table class="retro-table" id="currentExecutionsTable">
                                <thead>
                                    <tr>
                                        <th>Execution ID</th>
                                        <th>Package Name</th>
                                        <th>Status</th>
                                        <th>Started</th>
                                        <th>Duration</th>
                                        <th>Executed By</th>
                                        <th>Alert</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var exec in Model.CurrentExecutions)
                                    {
                                        <tr>
                                            <td><strong style="color: var(--neon-cyan);">@exec.ExecutionId</strong></td>
                                            <td>@exec.PackageName</td>
                                            <td><span class="retro-badge retro-badge--purple">@exec.StatusDescription</span></td>
                                            <td>@exec.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>
                                                @{
                                                    var duration = TimeSpan.FromSeconds(exec.DurationSeconds);
                                                    <span class="@(exec.IsLongRunning ? "retro-neon-text retro-neon-text--pink" : "")" style="font-weight: @(exec.IsLongRunning ? "bold" : "normal");">
                                                        @string.Format("{0:D2}:{1:D2}:{2:D2}", duration.Hours, duration.Minutes, duration.Seconds)
                                                    </span>
                                                }
                                            </td>
                                            <td>@exec.ExecutedBy</td>
                                            <td>
                                                @if (exec.IsLongRunning)
                                                {
                                                    <span class="retro-badge retro-badge--orange" title="Running longer than 30 minutes">
                                                        <i class="bi bi-exclamation-triangle-fill"></i> Long Running
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="retro-alert retro-alert--success">
                            <div class="retro-alert__content">
                                <i class="bi bi-info-circle-fill"></i> No packages currently executing
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Package Performance Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="retro-card retro-card--purple retro-card--cut">
                <div class="retro-card__header" style="color: var(--neon-purple);">
                    <i class="bi bi-speedometer2"></i> PACKAGE PERFORMANCE (Last 30 Days)
                </div>
                <div class="retro-card__body">
                    @if (Model.PackagePerformanceStats != null && Model.PackagePerformanceStats.Any())
                    {
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="retro-table">
                                <thead class="sticky-top">
                                    <tr>
                                        <th>Package</th>
                                        <th>Executions</th>
                                        <th>Success Rate</th>
                                        <th>Avg Duration</th>
                                        <th>Last Run</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var perf in Model.PackagePerformanceStats.Take(10))
                                    {
                                        <tr>
                                            <td class="text-truncate" style="max-width: 200px;" title="@perf.PackageName">@perf.PackageName</td>
                                            <td><span class="retro-badge retro-badge--cyan">@perf.TotalExecutions</span></td>
                                            <td>
                                                <div class="retro-progress">
                                                    <div class="retro-progress__bar" 
                                                         style="width: @perf.SuccessRate%; background: linear-gradient(90deg, @(perf.SuccessRate >= 90 ? "var(--neon-green)" : perf.SuccessRate >= 70 ? "var(--neon-orange)" : "var(--neon-pink)") 0%, @(perf.SuccessRate >= 90 ? "var(--neon-green-bright)" : perf.SuccessRate >= 70 ? "var(--neon-orange-bright)" : "var(--neon-pink-bright)") 50%, @(perf.SuccessRate >= 90 ? "var(--neon-green)" : perf.SuccessRate >= 70 ? "var(--neon-orange)" : "var(--neon-pink)") 100%);">
                                                    </div>
                                                </div>
                                                <span style="font-size: var(--retro-text-sm); color: @(perf.SuccessRate >= 90 ? "var(--neon-green)" : perf.SuccessRate >= 70 ? "var(--neon-orange)" : "var(--neon-pink)");">
                                                    @perf.SuccessRate%
                                                </span>
                                            </td>
                                            <td>
                                                @{
                                                    var avgDuration = TimeSpan.FromSeconds(perf.AvgDurationSeconds);
                                                    <span>@string.Format("{0:D2}:{1:D2}:{2:D2}", avgDuration.Hours, avgDuration.Minutes, avgDuration.Seconds)</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="retro-badge retro-badge--@(perf.LastExecutionStatus == "Success" ? "green" : "pink")">
                                                    @perf.LastExecutionStatus
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p style="color: rgba(0, 245, 255, 0.6); margin-bottom: 0;">No performance data available</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="retro-card retro-card--pink retro-card--cut">
                <div class="retro-card__header" style="color: var(--neon-pink);">
                    <i class="bi bi-bug-fill"></i> TOP FAILURE PATTERNS (Last 30 Days)
                </div>
                <div class="retro-card__body">
                    @if (Model.FailurePatterns != null && Model.FailurePatterns.Any())
                    {
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="retro-table">
                                <thead class="sticky-top">
                                    <tr>
                                        <th>Package</th>
                                        <th>Failures</th>
                                        <th>Failure Rate</th>
                                        <th>Last Failure</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var pattern in Model.FailurePatterns.Take(10))
                                    {
                                        <tr>
                                            <td class="text-truncate" style="max-width: 200px;" title="@pattern.PackageName">
                                                <strong style="color: var(--neon-pink);">@pattern.PackageName</strong>
                                            </td>
                                            <td><span class="retro-badge retro-badge--pink">@pattern.FailureCount</span></td>
                                            <td>
                                                <span class="retro-neon-text retro-neon-text--pink" style="font-weight: bold;">@pattern.FailureRate%</span>
                                            </td>
                                            <td>
                                                <small>@(pattern.LastFailureTime?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="4" style="background: rgba(255, 0, 110, 0.05); padding: var(--retro-space-1);">
                                                <small class="text-truncate d-block" style="max-width: 100%; color: rgba(255, 0, 110, 0.8);" title="@pattern.MostCommonError">
                                                    <i class="bi bi-exclamation-circle-fill"></i> @pattern.MostCommonError
                                                </small>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="retro-alert retro-alert--success">
                            <div class="retro-alert__content">
                                <i class="bi bi-check-circle-fill"></i> No failures detected in the last 30 days!
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Timeline -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="retro-card retro-card--green retro-card--cut">
                <div class="retro-card__header" style="color: var(--neon-green);">
                    <i class="bi bi-clock-history"></i> EXECUTION TIMELINE (Last 24 Hours)
                </div>
                <div class="retro-card__body">
                    @if (Model.ExecutionTimeline != null && Model.ExecutionTimeline.Any())
                    {
                        <div class="timeline" style="max-height: 500px; overflow-y: auto;">
                            @foreach (var item in Model.ExecutionTimeline)
                            {
                                <div class="timeline-item ps-3 pb-3 mb-3" style="border-left: 3px solid @(item.StatusColor == "success" ? "var(--neon-green)" : item.StatusColor == "danger" ? "var(--neon-pink)" : "var(--neon-cyan)");">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <span class="retro-badge retro-badge--@(item.StatusColor == "success" ? "green" : item.StatusColor == "danger" ? "pink" : "cyan")">@item.Status</span>
                                                <strong style="color: var(--neon-cyan); margin-left: 8px;">@item.PackageName</strong>
                                            </h6>
                                            <p class="mb-1" style="color: rgba(0, 245, 255, 0.6);">
                                                <small>
                                                    <i class="bi bi-clock"></i> Started: @item.StartTime.ToString("yyyy-MM-dd HH:mm:ss")
                                                    @if (item.EndTime.HasValue)
                                                    {
                                                        <span>| Ended: @item.EndTime.Value.ToString("HH:mm:ss")</span>
                                                    }
                                                </small>
                                            </p>
                                            <p class="mb-0">
                                                <span class="retro-badge retro-badge--cyan">Duration: @item.DurationMinutes min</span>
                                                <span class="retro-badge retro-badge--purple ms-2">ID: @item.ExecutionId</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p style="color: rgba(0, 245, 255, 0.6); margin-bottom: 0;">No executions in the last 24 hours</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row g-4 mb-4" id="metricsCards">
        <div class="col-md-3">
            <div class="retro-card retro-neon-box" style="border-color: var(--neon-cyan); position: relative;">
                <div class="spinner-overlay d-none">
                    <div class="retro-spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                </div>
                <h6 style="font-family: var(--font-retro-display); color: rgba(0, 245, 255, 0.7); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: var(--retro-space-1);">Total Executions</h6>
                <h2 id="totalExecutions" class="retro-neon-text" style="font-size: var(--retro-text-4xl); margin: var(--retro-space-2) 0;">@Model.Metrics.TotalExecutions</h2>
                <p style="color: rgba(0, 245, 255, 0.5); margin: 0;">Last 30 days</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="retro-card retro-neon-box" style="border-color: var(--neon-green); position: relative;">
                <div class="spinner-overlay d-none">
                    <div class="retro-spinner" style="width: 30px; height: 30px; border-width: 3px; border-top-color: var(--neon-green);"></div>
                </div>
                <h6 style="font-family: var(--font-retro-display); color: rgba(57, 255, 20, 0.7); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: var(--retro-space-1);">Successful</h6>
                <h2 id="successfulExecutions" class="retro-neon-text retro-neon-text--green" style="font-size: var(--retro-text-4xl); margin: var(--retro-space-2) 0;">@Model.Metrics.SuccessfulExecutions</h2>
                <p id="successRate" style="color: rgba(57, 255, 20, 0.5); margin: 0;">@Model.Metrics.SuccessRate% success rate</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="retro-card retro-neon-box" style="border-color: var(--neon-pink); position: relative;">
                <div class="spinner-overlay d-none">
                    <div class="retro-spinner" style="width: 30px; height: 30px; border-width: 3px; border-top-color: var(--neon-pink);"></div>
                </div>
                <h6 style="font-family: var(--font-retro-display); color: rgba(255, 0, 110, 0.7); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: var(--retro-space-1);">Failed</h6>
                <h2 id="failedExecutions" class="retro-neon-text retro-neon-text--pink" style="font-size: var(--retro-text-4xl); margin: var(--retro-space-2) 0;">@Model.Metrics.FailedExecutions</h2>
                <p style="color: rgba(255, 0, 110, 0.5); margin: 0;">Requires attention</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="retro-card retro-neon-box" style="border-color: var(--neon-purple); position: relative;">
                <div class="spinner-overlay d-none">
                    <div class="retro-spinner" style="width: 30px; height: 30px; border-width: 3px; border-top-color: var(--neon-purple);"></div>
                </div>
                <h6 style="font-family: var(--font-retro-display); color: rgba(157, 78, 221, 0.7); font-size: var(--retro-text-sm); text-transform: uppercase; margin-bottom: var(--retro-space-1);">Avg Duration</h6>
                <h2 id="avgDuration" class="retro-neon-text retro-neon-text--purple" style="font-size: var(--retro-text-4xl); margin: var(--retro-space-2) 0;">@Model.Metrics.AvgDuration s</h2>
                <p style="color: rgba(157, 78, 221, 0.5); margin: 0;">Average execution time</p>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="retro-card retro-card--cut">
                <div class="retro-card__header">
                    <i class="bi bi-pie-chart-fill"></i> SUCCESS RATE DISTRIBUTION
                </div>
                <div class="retro-card__body">
                    <canvas id="successRateChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="retro-card retro-card--cut">
                <div class="retro-card__header">
                    <i class="bi bi-graph-up"></i> EXECUTION TRENDS (Last 30 Days)
                </div>
                <div class="retro-card__body">
                    <canvas id="trendsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Executions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="retro-card retro-card--cut position-relative" id="recentExecutionsCard">
                <div class="retro-card__header">
                    <i class="bi bi-list-ul"></i> RECENT EXECUTIONS
                </div>
                <div class="spinner-overlay d-none">
                    <div class="retro-spinner"></div>
                </div>
                <div class="retro-card__body">
                    <div class="table-responsive">
                        <table class="retro-table" id="recentExecutionsTable">
                            <thead>
                                <tr>
                                    <th>Execution ID</th>
                                    <th>Package</th>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Start Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.RecentExecutions != null && Model.RecentExecutions.Any())
                                {
                                    @foreach (var execution in Model.RecentExecutions)
                                    {
                                        <tr>
                                            <td><strong style="color: var(--neon-cyan);">@execution.ExecutionId</strong></td>
                                            <td>@execution.PackageName</td>
                                            <td>@execution.ProjectName</td>
                                            <td>
                                                @if (execution.Status == "Succeeded")
                                                {
                                                    <span class="retro-badge retro-badge--green">@execution.Status</span>
                                                }
                                                else if (execution.Status == "Failed")
                                                {
                                                    <span class="retro-badge retro-badge--pink">@execution.Status</span>
                                                }
                                                else if (execution.Status == "Running")
                                                {
                                                    <span class="badge bg-primary">@execution.Status</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">@execution.Status</span>
                                                }
                                            </td>
                                            <td>@execution.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>@FormatDuration(execution.Duration)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle"></i> No recent executions found in the last 30 days.
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Last 10 Executed Packages -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card position-relative" id="lastExecutedPackagesCard">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Last 10 Executed Packages</h5>
                </div>
                <div class="spinner-overlay d-none">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="lastExecutedPackagesTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Execution ID</th>
                                    <th>Package Name</th>
                                    <th>Folder</th>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.LastExecutedPackages != null && Model.LastExecutedPackages.Any())
                                {
                                    @foreach (var package in Model.LastExecutedPackages)
                                    {
                                        <tr>
                                            <td><span class="badge bg-secondary">@package.ExecutionId</span></td>
                                            <td><strong>@package.PackageName</strong></td>
                                            <td>@package.FolderName</td>
                                            <td>@package.ProjectName</td>
                                            <td>
                                                @if (package.Status == "Succeeded")
                                            {
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> @package.Status
                                                </span>
                                            }
                                            else if (package.Status == "Failed")
                                            {
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-x-circle"></i> @package.Status
                                                </span>
                                            }
                                            else if (package.Status == "Running")
                                            {
                                                <span class="badge bg-primary">
                                                    <i class="bi bi-arrow-clockwise"></i> @package.Status
                                                </span>
                                            }
                                            else if (package.Status == "Pending")
                                            {
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-hourglass"></i> @package.Status
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@package.Status</span>
                                            }
                                        </td>
                                        <td>@package.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>
                                            @if (package.EndTime.HasValue)
                                            {
                                                @package.EndTime.Value.ToString("yyyy-MM-dd HH:mm:ss")
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (package.Duration > 0)
                                            {
                                                @FormatDuration(package.Duration)
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle"></i> No package executions found.
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Errors -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Errors</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recentErrorsTable">
                            <thead>
                                <tr>
                                    <th>Execution ID</th>
                                    <th>Package</th>
                                    <th>Error Time</th>
                                    <th>Error Code</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.RecentErrors != null && Model.RecentErrors.Any())
                                {
                                    @foreach (var error in Model.RecentErrors)
                                    {
                                        <tr>
                                            <td>@error.ExecutionId</td>
                                            <td>@error.PackageName</td>
                                            <td>@error.ErrorTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>@error.ErrorCode</td>
                                            <td class="text-truncate" style="max-width: 400px;">@error.ErrorDescription</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="alert alert-success mb-0">
                                                <i class="bi bi-check-circle"></i> No errors found in the last 30 days. Great job!
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string FormatDuration(int seconds)
    {
        var hours = seconds / 3600;
        var minutes = (seconds % 3600) / 60;
        var secs = seconds % 60;

        if (hours > 0)
            return $"{hours}h {minutes}m {secs}s";
        else if (minutes > 0)
            return $"{minutes}m {secs}s";
        else
            return $"{secs}s";
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global chart instances
        let successChart;
        let trendsChart;
        let autoRefreshInterval;
        const REFRESH_INTERVAL = 5000; // 5 seconds

        // Initialize charts
        function initCharts() {
            // Retro theme colors
            const retroColors = {
                cyan: '#00f5ff',
                green: '#39ff14',
                pink: '#ff006e',
                purple: '#9d4edd',
                cyanGlow: 'rgba(0, 245, 255, 0.3)',
                greenGlow: 'rgba(57, 255, 20, 0.3)',
                pinkGlow: 'rgba(255, 0, 110, 0.3)',
                textColor: 'rgba(0, 245, 255, 0.8)'
            };

            // Success Rate Pie Chart
            const successCtx = document.getElementById('successRateChart').getContext('2d');
            successChart = new Chart(successCtx, {
                type: 'pie',
                data: {
                    labels: ['Successful', 'Failed'],
                    datasets: [{
                        data: [@Model.Metrics.SuccessfulExecutions, @Model.Metrics.FailedExecutions],
                        backgroundColor: [retroColors.green, retroColors.pink],
                        borderColor: ['rgba(57, 255, 20, 0.8)', 'rgba(255, 0, 110, 0.8)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: retroColors.textColor,
                                font: {
                                    family: 'Share Tech Mono, monospace',
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });

            // Trends Line Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [@Html.Raw(string.Join(",", Model.Trends.Select(t => $"'{t.Date}'")))],
                    datasets: [{
                        label: 'Successful',
                        data: [@string.Join(",", Model.Trends.Select(t => t.Success))],
                        borderColor: retroColors.green,
                        backgroundColor: retroColors.greenGlow,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: retroColors.green,
                        pointBorderColor: retroColors.green,
                        pointHoverBackgroundColor: '#5dff42',
                        pointHoverBorderColor: '#5dff42'
                    }, {
                        label: 'Failed',
                        data: [@string.Join(",", Model.Trends.Select(t => t.Failed))],
                        borderColor: retroColors.pink,
                        backgroundColor: retroColors.pinkGlow,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: retroColors.pink,
                        pointBorderColor: retroColors.pink,
                        pointHoverBackgroundColor: '#ff1a8c',
                        pointHoverBorderColor: '#ff1a8c'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: retroColors.textColor,
                                font: {
                                    family: 'Share Tech Mono, monospace',
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 245, 255, 0.1)'
                            },
                            ticks: {
                                color: retroColors.textColor,
                                font: {
                                    family: 'Share Tech Mono, monospace'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 245, 255, 0.1)'
                            },
                            ticks: {
                                color: retroColors.textColor,
                                font: {
                                    family: 'Share Tech Mono, monospace'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Show loading indicators
        function showLoading() {
            document.getElementById('refreshBtn').classList.add('loading');
            document.querySelectorAll('.spinner-overlay').forEach(spinner => {
                spinner.classList.remove('d-none');
            });
            document.querySelectorAll('#metricsCards .retro-card').forEach(card => {
                card.classList.add('loading');
            });
        }

        // Hide loading indicators
        function hideLoading() {
            document.getElementById('refreshBtn').classList.remove('loading');
            document.querySelectorAll('.spinner-overlay').forEach(spinner => {
                spinner.classList.add('d-none');
            });
            document.querySelectorAll('#metricsCards .retro-card').forEach(card => {
                card.classList.remove('loading');
                card.classList.add('pulse');
                setTimeout(() => card.classList.remove('pulse'), 1000);
            });
        }

        // Fetch and update metrics via AJAX
        async function updateMetrics() {
            try {
                const response = await fetch('/Dashboard/GetMetrics');
                if (!response.ok) throw new Error('Failed to fetch metrics');
                
                const metrics = await response.json();
                
                // Update metric cards using IDs
                document.getElementById('totalExecutions').textContent = metrics.totalExecutions;
                document.getElementById('successfulExecutions').textContent = metrics.successfulExecutions;
                document.getElementById('successRate').textContent = `${metrics.successRate}% success rate`;
                document.getElementById('failedExecutions').textContent = metrics.failedExecutions;
                document.getElementById('avgDuration').textContent = `${metrics.avgDuration} s`;
                
                // Update success chart
                successChart.data.datasets[0].data = [metrics.successfulExecutions, metrics.failedExecutions];
                successChart.update();
                
                console.log('✅ Metrics updated successfully');
            } catch (error) {
                console.error('❌ Error updating metrics:', error);
            }
        }

        // Fetch and update trends via AJAX
        async function updateTrends() {
            try {
                const response = await fetch('/Dashboard/GetTrends');
                if (!response.ok) throw new Error('Failed to fetch trends');
                
                const trends = await response.json();
                
                // Update trends chart
                trendsChart.data.labels = trends.map(t => t.date);
                trendsChart.data.datasets[0].data = trends.map(t => t.success);
                trendsChart.data.datasets[1].data = trends.map(t => t.failed);
                trendsChart.update();
                
                console.log('✅ Trends updated successfully');
            } catch (error) {
                console.error('❌ Error updating trends:', error);
            }
        }

        // Fetch and update last executed packages via AJAX
        async function updateLastExecutedPackages() {
            try {
                const response = await fetch('/Dashboard/GetLastExecutedPackages');
                if (!response.ok) throw new Error('Failed to fetch last executed packages');
                
                const packages = await response.json();
                
                // Update the table body
                const tbody = document.querySelector('#lastExecutedPackagesTable tbody');
                tbody.innerHTML = '';
                
                packages.forEach(pkg => {
                    const statusBadge = getStatusBadgeHTML(pkg.status);
                    const endTime = pkg.endTime ? new Date(pkg.endTime).toLocaleString('sv-SE').replace('T', ' ') : '-';
                    const duration = pkg.duration > 0 ? formatDuration(pkg.duration) : '-';
                    const startTime = new Date(pkg.startTime).toLocaleString('sv-SE').replace('T', ' ');
                    
                    const row = `
                        <tr>
                            <td><span class="badge bg-secondary">${pkg.executionId}</span></td>
                            <td><strong>${pkg.packageName}</strong></td>
                            <td>${pkg.folderName}</td>
                            <td>${pkg.projectName}</td>
                            <td>${statusBadge}</td>
                            <td>${startTime}</td>
                            <td>${endTime}</td>
                            <td>${duration}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
                console.log('✅ Last executed packages updated successfully');
            } catch (error) {
                console.error('❌ Error updating last executed packages:', error);
            }
        }

        // Helper function to generate status badge HTML
        function getStatusBadgeHTML(status) {
            if (status === 'Succeeded') {
                return '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Succeeded</span>';
            } else if (status === 'Failed') {
                return '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Failed</span>';
            } else if (status === 'Running') {
                return '<span class="badge bg-primary"><i class="bi bi-arrow-clockwise"></i> Running</span>';
            } else if (status === 'Pending') {
                return '<span class="badge bg-warning"><i class="bi bi-hourglass"></i> Pending</span>';
            } else {
                return `<span class="badge bg-secondary">${status}</span>`;
            }
        }

        // Helper function to format duration
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // Update all dashboard data
        async function refreshDashboard() {
            console.log('🔄 Refreshing dashboard data...');
            showLoading();
            
            await Promise.all([
                updateMetrics(),
                updateTrends(),
                updateLastExecutedPackages()
            ]);
            
            hideLoading();
            
            // Update last refresh time
            const now = new Date().toLocaleTimeString();
            console.log(`✨ Dashboard refreshed at ${now}`);
        }

        // Start auto-refresh
        function startAutoRefresh() {
            console.log(`🚀 Auto-refresh enabled (every ${REFRESH_INTERVAL / 1000} seconds)`);
            autoRefreshInterval = setInterval(refreshDashboard, REFRESH_INTERVAL);
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                console.log('⏸️ Auto-refresh paused');
            }
        }

        // Manual refresh button handler
        function manualRefresh() {
            // Clear filters and refresh to show all data
            window.location.href = window.location.pathname;
        }

        // SignalR Connection
        let connection;
        
        function setupSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/dashboardHub")
                .withAutomaticReconnect()
                .build();

            // Handle metrics updates from server
            connection.on("ReceiveMetricsUpdate", function(metrics) {
                console.log('📡 Received metrics update via SignalR');
                // Update UI with pushed data using IDs
                document.getElementById('totalExecutions').textContent = metrics.totalExecutions;
                document.getElementById('successfulExecutions').textContent = metrics.successfulExecutions;
                document.getElementById('successRate').textContent = `${metrics.successRate}% success rate`;
                document.getElementById('failedExecutions').textContent = metrics.failedExecutions;
                document.getElementById('avgDuration').textContent = `${metrics.avgDuration} s`;
            });

            // Handle trends updates from server
            connection.on("ReceiveTrendsUpdate", function(trends) {
                console.log('📡 Received trends update via SignalR');
                trendsChart.data.labels = trends.map(t => t.date);
                trendsChart.data.datasets[0].data = trends.map(t => t.success);
                trendsChart.data.datasets[1].data = trends.map(t => t.failed);
                trendsChart.update();
            });

            // Handle last executed packages updates from server
            connection.on("ReceiveLastExecutedPackagesUpdate", function(packages) {
                console.log('📡 Received last executed packages update via SignalR');
                const tbody = document.querySelector('#lastExecutedPackagesTable tbody');
                tbody.innerHTML = '';
                
                packages.forEach(pkg => {
                    const statusBadge = getStatusBadgeHTML(pkg.status);
                    const endTime = pkg.endTime ? new Date(pkg.endTime).toLocaleString('sv-SE').replace('T', ' ') : '-';
                    const duration = pkg.duration > 0 ? formatDuration(pkg.duration) : '-';
                    const startTime = new Date(pkg.startTime).toLocaleString('sv-SE').replace('T', ' ');
                    
                    const row = `
                        <tr>
                            <td><span class="badge bg-secondary">${pkg.executionId}</span></td>
                            <td><strong>${pkg.packageName}</strong></td>
                            <td>${pkg.folderName}</td>
                            <td>${pkg.projectName}</td>
                            <td>${statusBadge}</td>
                            <td>${startTime}</td>
                            <td>${endTime}</td>
                            <td>${duration}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });

            // Handle connection events
            connection.on("Connected", function(connectionId) {
                console.log(`✅ SignalR Connected: ${connectionId}`);
                document.getElementById('autoRefreshStatus').innerHTML = 
                    '<i class="bi bi-broadcast"></i> Live Updates: ON';
            });

            connection.on("DataRefreshed", function() {
                console.log('🔔 Server notified: Data refreshed');
                refreshDashboard();
            });

            connection.onreconnecting(() => {
                console.log('🔄 SignalR reconnecting...');
                document.getElementById('autoRefreshStatus').classList.replace('bg-success', 'bg-warning');
            });

            connection.onreconnected(() => {
                console.log('✅ SignalR reconnected');
                document.getElementById('autoRefreshStatus').classList.replace('bg-warning', 'bg-success');
            });

            connection.onclose(() => {
                console.log('❌ SignalR disconnected');
                document.getElementById('autoRefreshStatus').innerHTML = 'Auto-refresh: ON';
                document.getElementById('autoRefreshStatus').classList.replace('bg-success', 'bg-secondary');
            });

            // Start connection
            connection.start()
                .then(() => console.log('🚀 SignalR connection established'))
                .catch(err => {
                    console.error('❌ SignalR connection failed:', err);
                    console.log('⚠️ Falling back to polling mode');
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set selected business unit from server
            const selectedBusinessUnit = '@(ViewBag.SelectedBusinessUnit ?? "")';
            if (selectedBusinessUnit) {
                const businessUnitDropdown = document.getElementById('businessUnitFilter');
                if (businessUnitDropdown) {
                    businessUnitDropdown.value = selectedBusinessUnit;
                    console.log('📌 Business Unit Filter Active:', selectedBusinessUnit);
                }
            }
            
            // Add Enter key support for search box
            const searchBox = document.getElementById('packageSearch');
            if (searchBox) {
                searchBox.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFilters();
                    }
                });
            }
            
            // Auto-apply filters when dropdowns change
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    const currentBU = '@(ViewBag.SelectedBusinessUnit ?? "")';
                    const selectedBU = document.getElementById('businessUnitFilter').value;
                    if (selectedBU === currentBU) {
                        applyFilters();
                    }
                });
            }
            
            initCharts();
            startAutoRefresh();
            setupSignalR();
            
            // Add visual feedback
            console.log('📊 SSIS Analytics Dashboard initialized');
            console.log(`⏰ Auto-refresh: Every ${REFRESH_INTERVAL / 1000} seconds`);
            console.log('📡 SignalR: Real-time updates enabled');
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
            if (connection) {
                connection.stop();
            }
        });

        // Filter functionality
        function applyFilters() {
            const businessUnit = document.getElementById('businessUnitFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('packageSearch').value.toLowerCase();
            
            // If business unit changed, reload page with the new business unit filter
            const currentBusinessUnit = '@(ViewBag.SelectedBusinessUnit ?? "")';
            if (businessUnit !== currentBusinessUnit) {
                if (businessUnit) {
                    window.location.href = `?businessUnit=${encodeURIComponent(businessUnit)}`;
                } else {
                    window.location.href = window.location.pathname;
                }
                return;
            }
            
            // Client-side filtering for status and search
            // Filter Recent Executions (Package at index 1, Status at index 3)
            filterTable('recentExecutionsTable', statusFilter, searchTerm, 1, 3);
            
            // Filter Last Executed Packages (Package Name at index 1, Status at index 4)
            filterTable('lastExecutedPackagesTable', statusFilter, searchTerm, 1, 4);
            
            console.log('✅ Filters applied:', { statusFilter, searchTerm });
        }

        function clearFilters() {
            // Check if we need to reload the page (business unit is set)
            const currentBusinessUnit = '@(ViewBag.SelectedBusinessUnit ?? "")';
            if (currentBusinessUnit && currentBusinessUnit.length > 0) {
                // Reload page without any query parameters
                window.location.href = window.location.pathname;
                return;
            }
            
            // Clear all filter fields
            document.getElementById('businessUnitFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('packageSearch').value = '';
            
            // Show all rows in both tables
            showAllRows('recentExecutionsTable');
            showAllRows('lastExecutedPackagesTable');
            
            console.log('✅ All filters cleared');
        }
        
        function showAllRows(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            
            const rows = tbody.getElementsByTagName('tr');
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                // Show all data rows, but keep "no data" rows hidden if they exist
                if (cells.length > 0 && !cells[0].getAttribute('colspan')) {
                    row.style.display = '';
                }
            }
        }

        function filterTable(tableId, status, searchTerm, packageNameCol, statusCol) {
            const table = document.getElementById(tableId);
            if (!table) {
                console.warn(`Table ${tableId} not found`);
                return;
            }
            
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.warn(`Table body for ${tableId} not found`);
                return;
            }
            
            const rows = tbody.getElementsByTagName('tr');
            let visibleCount = 0;
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                
                // Skip empty rows or "no data" rows
                if (cells.length === 0 || cells[0].getAttribute('colspan')) {
                    row.style.display = 'none';
                    continue;
                }
                
                // Get package name and status text
                const packageName = cells[packageNameCol] ? cells[packageNameCol].textContent.toLowerCase().trim() : '';
                const rowStatus = cells[statusCol] ? cells[statusCol].textContent.toLowerCase().trim() : '';
                
                let showRow = true;
                
                // Status filter - check if status contains the filter text
                if (status && status.length > 0) {
                    if (!rowStatus.includes(status.toLowerCase())) {
                        showRow = false;
                    }
                }
                
                // Search filter - check if package name contains search term
                if (searchTerm && searchTerm.length > 0) {
                    if (!packageName.includes(searchTerm)) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            }
            
            console.log(`${tableId}: ${visibleCount} of ${rows.length} rows visible`);
        }

        // Export to CSV functionality
        function exportToCSV() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            const timestamp = new Date().toISOString().slice(0, 10);
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Export Metrics
            csvContent += "SSIS Analytics Export - " + timestamp + "\n\n";
            csvContent += "Metrics Summary\n";
            csvContent += "Metric,Value\n";
            csvContent += `Total Executions,@Model.Metrics.TotalExecutions\n`;
            csvContent += `Successful Executions,@Model.Metrics.SuccessfulExecutions\n`;
            csvContent += `Failed Executions,@Model.Metrics.FailedExecutions\n`;
            csvContent += `Success Rate,@Model.Metrics.SuccessRate%\n`;
            csvContent += `Average Duration,@Model.Metrics.AvgDuration seconds\n\n`;
            
            // Export Last Executed Packages
            csvContent += "Last 10 Executed Packages\n";
            csvContent += "Execution ID,Package Name,Folder,Project,Status,Start Time,End Time,Duration (seconds)\n";
            
            @foreach (var pkg in Model.LastExecutedPackages ?? new List<SSISAnalyticsDashboard.Models.PackageExecution>())
            {
                var endTime = pkg.EndTime.HasValue ? pkg.EndTime.Value.ToString("yyyy-MM-dd HH:mm:ss") : "N/A";
                <text>
                csvContent += `@pkg.ExecutionId,"@pkg.PackageName","@pkg.FolderName","@pkg.ProjectName","@pkg.Status","@pkg.StartTime.ToString("yyyy-MM-dd HH:mm:ss")","@endTime",@pkg.Duration\n`;
                </text>
            }
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `SSIS_Analytics_${timestamp}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('✅ Data exported to CSV');
        }
    </script>
}
